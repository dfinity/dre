name: Build and test
on:
  push:
    branches:
      - 'main'
  pull_request:
  merge_group:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '30 1 * * *'
jobs:
  bazel:
    runs-on: ubuntu-22.04
    steps:
      - uses: ./.github/workflows/setup-bazel

      ########################################
      # Build and test
      ########################################
      - name: Set GIT_HASH variable
        run: |
          set -eExou pipefail
          # Set GIT_HASH variable based on the type of GitHub reference
          if [[ "$GITHUB_REF_TYPE" == "tag" ]]; then
            echo "GIT_HASH=$GITHUB_REF_NAME" >> "$GITHUB_ENV"  # Embed tag name as GIT_HASH
          else
            echo "GIT_HASH=$GITHUB_SHA" >> "$GITHUB_ENV"  # Embed commit SHA as GIT_HASH
          fi
      - run: bazel build ...
      - run: bazel test ...

      ########################################
      # Prepare release
      ########################################
      - name: Upload artifact for release
        uses: actions/upload-artifact@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: dre
          path: bazel-out/k8-opt/bin/rs/cli/dre
      - name: Call prepare release
        uses: ./.github/workflows/prepare-release.yaml

      ########################################
      # Upload container images
      ########################################
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Push images to GitHub Container Registry
        if: ${{ startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/heads/container') || (github.ref == 'refs/heads/main') }}
        run:
          bazel query --noshow_progress 'kind("oci_push", ...)' | xargs -I_target bazel run _target -- --tag ${GITHUB_SHA}

      ########################################
      # Update k8s deployments
      ########################################
      - name: Update k8s deployments
        if: ${{ startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/heads/container') || (github.ref == 'refs/heads/main') }}
        uses: ./.github/workflows/update-deployments.yaml
        secrets:
          GITLAB_API_TOKEN: ${{ secrets.GITLAB_API_TOKEN }}

      ########################################
      # Optimize bazel cache by hard-linking duplicate files
      ########################################
      - name: Optimize bazel cache directory before uploading
        run: bin/optimize-bazel-cache.sh
