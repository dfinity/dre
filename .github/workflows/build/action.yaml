name: Build and repin
description: Reusable action for building and repin with bazel

inputs:
  github_token:
    description: 'Automatically assigned GitHub Token'
    required: true

runs:
  using: composite
  steps:

    - name: "Build and repin"
      id: build
      run: |
        set -eExou pipefail
        function bazel_build_auto_repin() {
            local MYTMPDIR="$(mktemp -d)"
            trap 'rm -rf -- "$MYTMPDIR"' EXIT
            local logfile="$MYTMPDIR/bazel-out.log" 
            bazel "$@" 2>&1 | tee "$logfile" >&2
            local r=${PIPESTATUS[0]}
            if [ "$r" != "0" ]; then
                if grep -q 'Digests do not match' "$logfile" ; then
                    echo "repin=true" >> $GITHUB_OUTPUT
                    CARGO_BAZEL_REPIN=true bazel "$@" || return $?
                else
                    return $r
                fi
            fi
        }
        
        bazel_build_auto_repin build ...
      shell: bash

    - name: Commit & Push changes
      uses: actions-js/push@master
      if: ${{ steps.build.outputs.repin == 'true' }}"
      with:
        github_token: ${{ inputs.GITHUB_TOKEN }}
        branch: ${{ github.head_ref }}
        message: "Github Action: Bazel Repin"
