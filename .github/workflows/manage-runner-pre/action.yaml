name: Setup runner
description: Reusable action for setting up the github runner

inputs:
  aws_access_key_id:
    description: 'AWS Access Key ID'
    required: true
  aws_secret_access_key:
    description: 'AWS Secret Access Key'
    required: true

runs:
  using: composite
  steps:
    - name: "üëÆ‚Äç‚ôÄÔ∏è Setup runner"
      if: ${{ startsWith(runner.name, 'dre-runner-custom') }}
      shell: bash
      run: |
        set -euo pipefail
        sudo chown -R 1001:1001 ~/.cache
        echo "Changed ownership of cache to 1001:1001"

    ########################################
    # Setup
    ########################################
    - name: "üîß Free Up Disk Space"
      uses: jlumbroso/free-disk-space@v1.3.1
      if: ${{ !startsWith(runner.name, 'dre-runner-custom') }}
      with:
        # this might remove tools that are actually needed,
        # when set to "true" but frees about 6 GB
        tool-cache: true
        large-packages: true  # this is slow

    - uses: bazelbuild/setup-bazelisk@v2

    ########################################
    # Download and unpack cache
    ########################################
    - name: "‚òÅÔ∏è ‚¨áÔ∏è Restore bazel cache"
      uses: actions/cache/restore@v4
      if: ${{ !startsWith(runner.name, 'dre-runner-custom') }}
      with:
        path: "~/.cache/bazel"
        # Configure cache updates
        # https://github.com/actions/cache/blob/main/tips-and-workarounds.md#update-a-cache
        # https://github.com/actions/cache/blob/main/examples.md#---bazel
        key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', '.bazelrc', 'WORKSPACE.bazel', 'Cargo.Bazel.lock', 'requirements.txt') }}
        restore-keys: |
            ${{ runner.os }}-bazel-
    
    - name: "üßπ Clean bazel cache if we're preparing a new release"
      if: ${{ startsWith(github.ref, 'refs/tags/v') && !startsWith(runner.name, 'dre-runner-custom') }}
      # This is desirable to make sure bazel does not use stale pre-built binaries
      # Bazel actually keeps all intermediate objects so builds are still fast
      run: bazel clean
      shell: bash

    - name: "‚òÅÔ∏è Setup S3 cache credentials"
      if: ${{ !startsWith(runner.name, 'dre-runner-custom') }}
      id: bazel-remote-creds
      shell: bash
      run: |
        mkdir -p ~/.aws
        chmod 700 ~/.aws
        sudo chown -R $USER:$GROUP ~/.aws
        cat <<_EOF | install -m 0600 /dev/stdin ~/.aws/config
        [wasabi]
        region = eu-central-2
        _EOF
        cat <<_EOF | install -m 0600 /dev/stdin ~/.aws/credentials
        [wasabi]
        aws_access_key_id = ${{ inputs.aws_access_key_id }}
        aws_secret_access_key = ${{ inputs.aws_secret_access_key }}
        _EOF

    - name: "üíæ Start bazel-remote s3 cache"
      if: ${{ !startsWith(runner.name, 'dre-runner-custom') }}
      run: ./bin/bazel-cache-s3-start.sh
      shell: bash
        