name: Setup runner
description: Reusable action for setting up the github runner

inputs:
  AWS_ACCESS_KEY_ID:
    description: 'Access key for the S3 bucket'
    required: true
  AWS_SECRET_ACCESS_KEY:
    description: 'Secret key for the S3 bucket'
    required: true

runs:
  using: composite
  steps:
    ########################################
    # Setup
    ########################################
    - name: "üîß Free Up Disk Space"
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        # this might remove tools that are actually needed,
        # when set to "true" but frees about 6 GB
        tool-cache: true
        large-packages: false  # this is slow
    - uses: bazelbuild/setup-bazelisk@v2

    ########################################
    # Download and unpack cache
    ########################################
    - name: "‚òÅÔ∏è ‚¨áÔ∏è Mount caches"
      run: |
        mkdir -p ~/.cache/bazel
        sudo chown -R $USER:$USER ~/.cache/bazel
        sudo apt-get install -y s3fs
        s3fs dre-s3fs-ci-cache ~/.cache/bazel -o url=https://s3.eu-central-2.wasabisys.com -o use_path_request_style -o umask=0007
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.AWS_SECRET_ACCESS_KEY }}
      shell: bash
    - name: "üßπ Clean bazel cache if we're preparing a new release"
      if: ${{ startsWith(github.ref, 'refs/tags/v') }}
      # This is desirable to make sure bazel does not use stale pre-built binaries
      # Bazel actually keeps all intermediate objects so builds are still fast
      run: bazel clean
      shell: bash
