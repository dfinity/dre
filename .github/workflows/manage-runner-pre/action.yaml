name: Setup runner
description: Reusable action for setting up the github runner

inputs:
  aws_access_key_id:
    description: 'AWS Access Key ID'
    required: true
  aws_secret_access_key:
    description: 'AWS Secret Access Key'
    required: true

runs:
  using: composite
  steps:
    ########################################
    # Setup
    ########################################
    - uses: bazelbuild/setup-bazelisk@v2

    ########################################
    # Download and unpack cache
    ########################################
    - name: "‚òÅÔ∏è ‚¨áÔ∏è Restore bazel cache"
      uses: actions/cache/restore@v4
      with:
        path: "~/.cache/bazel"
        # Configure cache updates
        # https://github.com/actions/cache/blob/main/tips-and-workarounds.md#update-a-cache
        # https://github.com/actions/cache/blob/main/examples.md#---bazel
        key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', '.bazelrc', 'WORKSPACE.bazel', 'Cargo.Bazel.lock', 'requirements.txt') }}
        restore-keys: |
            ${{ runner.os }}-bazel-
    - name: "üßπ Clean bazel cache if we're preparing a new release"
      if: ${{ startsWith(github.ref, 'refs/tags/v') }}
      # This is desirable to make sure bazel does not use stale pre-built binaries
      # Bazel actually keeps all intermediate objects so builds are still fast
      run: bazel clean
      shell: bash

    - name: "üåé Setting up missing software"
      shell: bash
      run: |
        set -euo pipefail

        sudo apt-get update -y
        sudo apt-get upgrade -y

        sudo apt-get install ca-certificates curl git-all gcc g++ clang pkg-config make -y

        mkdir -p ~/.cache/bazel

        OPENSSL_VERSION="1.1.1w"
        OPENSSL_URL="https://www.openssl.org/source/old/1.1.1/openssl-${OPENSSL_VERSION}.tar.gz"
        TARGET_DIR="openssl"
        mkdir $TARGET_DIR

        # Download the specified OpenSSL version
        echo "Downloading OpenSSL ${OPENSSL_VERSION}..."
        curl -o "${TARGET_DIR}/openssl-${OPENSSL_VERSION}.tar.gz" -L "${OPENSSL_URL}"

        # Extract the tarball
        echo "Extracting OpenSSL ${OPENSSL_VERSION}..."
        mkdir -p "${TARGET_DIR}"
        tar -xzvf "${TARGET_DIR}/openssl-${OPENSSL_VERSION}.tar.gz" -C "${TARGET_DIR}"

        # Change to the OpenSSL directory
        cd "${TARGET_DIR}/openssl-${OPENSSL_VERSION}"

        # Configure the build
        echo "Configuring OpenSSL ${OPENSSL_VERSION}..."
        ./config

        # Build OpenSSL
        echo "Building OpenSSL ${OPENSSL_VERSION}..."
        make

        # Install OpenSSL
        echo "Installing OpenSSL ${OPENSSL_VERSION}..."
        sudo make install

        echo "OpenSSL ${OPENSSL_VERSION} installation completed successfully."

        openssl version