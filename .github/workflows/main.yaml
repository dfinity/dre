name: Build and test
on:
  push:
    branches:
      - "main"
  pull_request:
  merge_group:
jobs:
  bazel:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      # - uses: ./.github/workflows/setup-bazel
      #   name: Setup bazel

      ########################################
      # Build and test
      ########################################
      - name: Set GIT_HASH variable
        run: |
          set -eExou pipefail
          # Set GIT_HASH variable based on the type of GitHub reference
          if [[ "$GITHUB_REF_TYPE" == "tag" ]]; then
            echo "GIT_HASH=$GITHUB_REF_NAME" >> "$GITHUB_ENV"  # Embed tag name as GIT_HASH
          else
            echo "GIT_HASH=$GITHUB_SHA" >> "$GITHUB_ENV"  # Embed commit SHA as GIT_HASH
          fi
      # - run: bazel build ...
      #   name: Building
      # - run: bazel test ...
      #   name: Testing

      ########################################
      # Prepare release
      ########################################
      - name: Upload artifact for release
        uses: actions/upload-artifact@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: dre
          path: bazel-out/k8-opt/bin/rs/cli/dre
      - name: Call prepare release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: ./.github/workflows/prepare-release.yml

      ########################################
      # Upload container images
      ########################################
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Push images to GitHub Container Registry
        if: ${{ startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/heads/container') || (github.ref == 'refs/heads/main') }}
        run: bazel query --noshow_progress 'kind("oci_push", ...)' | xargs -I_target bazel run _target -- --tag ${GITHUB_SHA}

      ########################################
      # Optimize bazel cache by hard-linking duplicate files
      ########################################
      - name: Optimize bazel cache directory before uploading
        run: bin/optimize-bazel-cache.sh
