version: "3.8"
services:
  dashboard-backstage:
    restart: always
    environment:
      - APP_CONFIG_app_baseUrl=https://dashboard.mainnet.dfinity.systems
      - APP_CONFIG_backend_baseUrl=https://dashboard.mainnet.dfinity.systems
    links:
      - dashboard-backend-mainnet
      - dashboard-backend-staging
    networks:
    - backend
  dashboard-backend-mainnet:
    restart: always
    environment:
      - GITLAB_API_TOKEN_RELEASE
      - GITLAB_API_TOKEN_IC_PUBLIC
      - LOCAL_REGISTRY_PATH=/registry_cache
      - NNS_URL=https://nns.ic0.app
      - NETWORK=mercury
      - RUST_BACKTRACE=1
    volumes:
      - backend_registry_cache_mainnet:/registry_cache
    networks:
    - backend
  dashboard-backend-staging:
    image: registry.gitlab.com/dfinity-lab/core/release/dashboard-backend:${TAG:-latest}
    restart: always
    environment:
      - GITLAB_API_TOKEN_RELEASE
      - GITLAB_API_TOKEN_IC_PUBLIC
      - LOCAL_REGISTRY_PATH=/registry_cache
      - NNS_URL=http://[2600:3004:1200:1200:5000:7dff:fe29:a2f5]:8080
      - NETWORK=staging
      - RUST_BACKTRACE=1
    volumes:
      - backend_registry_cache_staging_2:/registry_cache
    networks:
    - backend
  slack:
    restart: always
    environment:
      - SLACK_URL
      - "SLACK_CHANNEL=#eng-release"
    volumes:
      - slack_state:/state/
    working_dir: /state/
  slack-watchdog:
    image: docker
    volumes: [ "/var/run/docker.sock:/var/run/docker.sock" ]
    command:
      [
        "/bin/sh",
        "-c",
        "while true; do sleep 60; if [ -z \"$$(docker logs release_slack_1 --since=1m 2>&1)\" ]; then echo -n \"restarting \"; docker restart release_slack_1; else echo \"target service is running\"; fi; done"
      ]
    restart: unless-stopped
  decentralization:
    restart: always

volumes:
  slack_state:
  backend_registry_cache_mainnet:
  backend_registry_cache_staging_2:

networks:
  backend:
    enable_ipv6: true
